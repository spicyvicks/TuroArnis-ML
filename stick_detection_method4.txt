STICK DETECTION: VIEWPOINT-SPECIFIC HANDLING GUIDE

OVERVIEW:
The system uses a custom-trained YOLOv8 model (deployment_package/weights/best.pt) that detects two keypoints on the Arnis stick: "grip" (held by hand) and "tip" (far end). However, raw YOLO predictions vary significantly based on camera viewpoint due to perspective distortion and foreshortening. We implement viewpoint-adaptive corrections to ensure consistent stick length and direction across all angles.

STEP 1: VIEWPOINT DETECTION
The system first determines if the camera is FRONT or SIDE view using one of two methods:
  
  Method A - GCN Viewpoint (Preferred):
  - If GCN inference is active, use the current_viewpoint setting ('front', 'left', or 'right')
  - 'front' = FRONT view, 'left'/'right' = SIDE view
  
  Method B - Automatic Detection (Fallback):
  - Calculate shoulder_width = distance between LEFT_SHOULDER and RIGHT_SHOULDER landmarks
  - Calculate avg_torso_length = average of (LEFT_SHOULDER to LEFT_HIP) and (RIGHT_SHOULDER to RIGHT_HIP)
  - Compute view_ratio = shoulder_width / avg_torso_length
  - If view_ratio > 0.45 → FRONT view (shoulders appear wide relative to torso)
  - If view_ratio ≤ 0.45 → SIDE view (shoulders appear narrow/overlapped)

STEP 2: GRIP-TIP SWAP VALIDATION
YOLO sometimes confuses which keypoint is grip vs tip. Before processing:
  
  - Measure distance from each keypoint to both wrists
  - The grip MUST be closer to a wrist than the tip
  - If tip is actually closer to wrist → swap the keypoints
  - Example: If tip is 45px from wrist and grip is 180px → swap them

STEP 3A: FRONT VIEW CORRECTION
Problem: When camera faces the practitioner, the stick appears foreshortened (compressed in depth). YOLO's detected tip is unreliable because the 71cm stick may only appear 60-80px long in the image.

Solutions Applied:
  1. GRIP ANCHOR:
     - Discard YOLO's grip location
     - Anchor grip to the MediaPipe WRIST landmark (RIGHT_WRIST or LEFT_WRIST, whichever is closer)
     - Why: MediaPipe's wrist tracking is more stable than YOLO's grip detection
  
  2. LENGTH CALCULATION:
     - Calculate stick_length_px = 1.5 × avg_torso_length_px
     - Why: A 71cm stick is roughly 1.5× the torso length (shoulder to hip) for most practitioners
     - Example: If torso = 120px → stick = 180px
  
  3. DIRECTION CALCULATION (BLENDED):
     - Get YOLO_direction = vector from grip to tip (normalized)
     - Get hand_direction = vector from WRIST to THUMB landmark (normalized)
     - Compute blended_direction = (0.4 × YOLO_direction) + (0.6 × hand_direction)
     - Normalize the blended vector
     - Why: In front view, the hand/thumb orientation is more reliable than YOLO's foreshortened tip
  
  4. FINAL TIP POSITION:
     - new_tip = grip_anchor + (blended_direction × stick_length_px)
     - Return corrected stick_endpoints = (grip_anchor, new_tip)

STEP 3B: SIDE VIEW CORRECTION  
Problem: From side angles, YOLO detects direction accurately, but length can be distorted by arm position and camera distance. The stick may appear longer or shorter than its true 71cm length.

Solutions Applied:
  1. GRIP ANCHOR:
     - Same as front view: anchor to MediaPipe WRIST landmark
  
  2. LENGTH CALCULATION (3D WORLD-BASED):
     - Get 3D world coordinates from MediaPipe:
       - wrist_3d = world coordinate of active wrist (x, y, z in meters)
       - elbow_3d = world coordinate of active elbow
     - Calculate forearm_length_meters = distance(wrist_3d, elbow_3d)
     - Known: standard Arnis stick = 0.71 meters
     - Compute length_ratio = 0.71 / forearm_length_meters
     - Calculate forearm_length_px = distance(wrist_2d, elbow_2d) in image pixels
     - Final stick_length_px = forearm_length_px × length_ratio
     - Example: If forearm = 0.30m (world) and 90px (image), then stick = 90px × (0.71/0.30) = 213px
  
  3. CLAMP OUTLIERS:
     - Calculate max_allowed = 2.5 × avg_torso_length_px
     - If stick_length_px > max_allowed → clamp to max_allowed
     - Why: Prevents extreme cases where pose estimation errors cause 500px+ sticks
  
  4. DIRECTION CALCULATION:
     - Use YOLO's detected direction directly: direction = (tip - grip) / ||tip - grip||
     - Why: Side view has minimal foreshortening; YOLO's tip is reliable
  
  5. FINAL TIP POSITION:
     - new_tip = grip_anchor + (direction × stick_length_px)
     - Return corrected stick_endpoints = (grip_anchor, new_tip)

STEP 4: OUTPUT
The corrected stick_endpoints tuple (grip_xy, tip_xy) is stored in the result dictionary and used for:
  - Visual overlay rendering (draw_stick_debug)
  - Grip angle calculation (angle between stick vector and arm vector)
  - Form validation in FeedbackAnalyzer

WHY THIS MATTERS:
Accurate stick detection is critical because:
  - Grip angle is a key feature for GCN classification (distinguishes thrusts from blocks)
  - Visual feedback helps practitioners see if they're holding the stick correctly
  - Incorrect length/direction would cause false feedback ("adjust your grip") when form is actually correct
  
The viewpoint-adaptive approach ensures that whether the user films from front, left, or right, the system provides consistent and accurate stick tracking for reliable form assessment.
